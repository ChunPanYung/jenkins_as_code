
def remote = [name: 'sshConnection', host: 'cloud.lan', allowAnyHosts: true]
pipeline {
    agent any
    options {
        skipDefaultCheckout() // Manual checkout stage
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM', branches: [[name: '**']],
                    extensions: [
                        [$class: 'SparseCheckoutPaths',
                         sparseCheckoutPaths: [[path: 'jobs/remote_update']]],
                        [$class: 'CloneOption', depth: 1, noTags: false,
                         reference: '', shallow: true]
                    ],
                    userRemoteConfigs: [
                        [url: 'https://github.com/ChunPanYung/jenkins_as_code']
                    ]
                ])
            }
        } // End stage('Checkout')

        stage('Remote SSH') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: 'server_ssh',
                        keyFileVariable: 'identity', usernameVariable: 'userName')]) {

                        remote.user = userName
                        remote.identityFile = identity
                        stage("SSH Steps Rocks!") {
                            sshCommand remote: remote, command: 'ls'
                        }
                    }
                    remote.user = $SSH_KEY_USR
                } // End script {}
                // sshCommand remote: remote, command: 'ls'
            }
        } // End stage Remote SSH
    } // End stages
}
